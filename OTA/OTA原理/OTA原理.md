# 1 概述

OTA(Over-The_Air)是一种通过无线通信技术实现远程更新设备固件或软件的方法。这项技术广泛应用于现代物联网（IoT）设备、智能手机、汽车、嵌入式系统等领域，提供了一种无需物理连接的便捷更新方式。OTA更新的核心在于使设备能够自动、可靠、安全地从远程服务器获取和应用更新，改善设备性能、添加新功能或修复安全漏洞。

# 2 工作原理

OTA更新的基本流程包括以下几个步骤：

1.**固件准备和打包**：开发者将最新的固件或软件版本进行打包，并上传到OTA服务器。打包过程中通常包括固件的制作、压缩、加密以及添加版本信息和校验码等步骤。

2.**设备检验更新**：设备通过无线网络定期或在特定触发条件下向OTA服务器查询是否存在新的固件版本。这通常涉及设备发送当前固件版本信息，并从服务器接收是否有新版本可用的响应。

3.**下载更新包**：如果存在新版本，设备从服务器下载固件包（固件包分为多种类型：全量、差分、流式、变分区升级包）。下载过程中，设备会进行数据校验（hash校验升级包完整性、签名验证包是否被篡改）以确保数据完整性和安全性。

4.**验证和安装**：下载完成后，设备会验证固件包的完整行和真实性，确认无误后开始安装。。安装过程中，旧的固件会被新的固件替换。为了保证系统稳定性，许多设备还会采用双分区（A/B分区）更新机制，使更新在后台进行，同时保证系统能够回滚到先前的稳定版本。还有为了内存的可利用性，设备采用流式升级的方式，边下载边升级，无需下载全部的固件数据。

5.**重启和应用更新**：安装完成后，设备通常需要重启以应用新的固件。如果安装失败，设备则可能会回滚到之前的固件版本。

# 3 关键技术

1.**固件包管理**：通俗来说就是升级包的制作，将需要更新的内容打包成固件包，并通过服务器进行发布。固件包中包含固件的压缩数据、校验信息和更新脚本等。固件包的制作还分为多种类型：全量、差分、流式、变分区升级包。其中如何差分也是比较关键的技术，校验信息也是需要考虑周全的。

2.**安全性**：OTA更新需要考虑安全性，以确保更新过程中不会出现安全漏洞或数据泄露。常见的安全措施包括使用加密算法对固件包进行加密，防止未经授权的访问和篡改，在固件包最后的使用私钥加密，在升级服务的时候使用公钥解密。同时还需要多次进行hash校验，来保证数据的完整性，防止别人来篡改。此外，OTA服务器也需要进行安全加固，包括使用HTTPS协议、身份验证和访问控制等。

3.**可靠性**：支持断电续传和回滚恢复功能，以防止更新过程因网络中断或其他故障导致的失败。通常包括对下载文件的部分校验、断点续传支持和异常回滚。

# 4 应用场景

1.**只能手机和平板**：智能手机和平板电脑通常会通过OTA推送系统更新和应用更新。例如，iOS、Android和openharmony设备会定期接收操作系统更新，以提供新功能、改进性能和修复安全漏洞。

2.**物联网设备**：物联网设备如智能家居设备（智能灯泡、智能锁）、传感器节点等通过OTA实现远程固件更新，确保设备能够适应新的协议和安全要求，提升用户体验。

3.**汽车**：现代汽车配备了车载信息娱乐系统和驾驶辅助系统，OTA更新可以用于远程更新这些系统的软件，提高功能、增加新特性或者修复已知问题。

4.**嵌入式系统**：各种嵌入式设备如智能手表、健身追踪器等，通过OTA更新来增强功能和改进用户界面，保持设备竞争力。

# 5 具体介绍

## 5.1 固件包制作

接下来会对固件包（升级包）的制作进行详细介绍，会对比各种类型的升级包，比较优点和缺点。

### 5.1.1 全量升级包

全量升级包是指将整个目标镜像打包成一个升级包，这个升级包包含了镜像的所有数据。

- 优点：

1. 制作简单，只需要将镜像打包成一个文件即可，制作包花费的时间少。
2. 升级稳定，镜像包简单，操作少，意味着更加稳定和成功率更高。

- 缺点：

1. 升级包体积大，对设备的内存和存储空间有一定的要求，升级时间过长。
2. 传输时间长，对网络的要求高。

### 5.1.2 差分升级包

差分升级包是指将目标镜像与当前镜像进行比较，只将不同的部分打包成一个升级包，这个升级包包含了镜像的不同部分数据。

- 优点：

1. 升级包体积小，对设备的内存和存储空间有一定的要求，升级时间较短。
2. 传输时间短，对网络的要求低。

- 缺点：

1. 升级包制作复杂，需要将当前镜像与目标镜像进行比较，制作包花费的时间长，需要调用bsdiff库进行差分计算。
2. 升级比全量较不稳定，镜像包复杂，操作多，意味着更加不稳定和成功率低。

### 5.1.3 流式升级包

流式升级包是在全量升级包和差分升级包的基础上，将升级包分成多个独立的数据块，采用专门设计的算法确保每个数据块在逻辑上相互独立，无需依赖于其他块可完整解析。

- 优点：

1. 升级包体积小，对设备的内存和存储空间要求不高。
2. 支持回退，在升级过程中，如果出现了升级异常，可以进行回退操作，恢复到之前的稳定版本。

- 缺点：

1. 升级包制作复杂，在制作差分流式升级包的时候，需要将当前镜像与目标镜像进行比较，制作包花费的时间长，需要调用bsdiff库进行差分计算，还要进行切片，耗时更长。在制作全量升级包的时候，需要将整个镜像进行切片，耗时也比单纯做全量升级包要耗时。
2. 升级比全量较不稳定，镜像包复杂，操作多，意味着更加不稳定和成功率低。

### 5.1.4 变分区升级包

除了以上三种升级包之外，还有一种变分区升级包，这种升级包是包含了分区表的，需要与厂家芯片进行强配合，因为不同芯片的bootloader加载方式不一样，如何启动分区也不一样，GPT分区表如何形成的方式需要与厂商强配合。

- 优点：

1. 可以任意增删分区数量。

> 补充：ab分区升级和单分区升级不列为升级包中，后续将不同升级方式进行比对，比较各种升级方式的优缺点。
> 以下列表普通全量，普通差分是单分区的全量和差分升级。
> AB全量、AB差分、AB流式升级为双分区的全量、差分和流式升级。

|            | 普通全量 | 普通差分 | AB全量 | AB差分 | AB流式 |
|-----------|----------|---------|--------|--------|--------|
|支持升级| Y | Y | Y | Y | Y |
|最小化升级| X | Y | X | Y | Y |
|无感升级| X | X | Y | Y | Y |
|支持回退| X | X | Y | Y | Y |
|支持小内存| X | X | X | X | Y |
