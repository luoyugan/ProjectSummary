# 1 UBOOT基本概念

## 1.1 uboot定义

当我们厌倦了裸机程序，而想要采用操作系统的时候，uboot就是不得不引入的一段程序。所以，uboot就是一段引导程序，在加载系统内核之前，完成硬件初始化，内存映射，为后续内核的引导提供一个良好的环境。uboot是bootloader的一种，全称为universal boot loader。

Linux 系统要启动需要通过 bootloader 程序引导，也就说芯片上电以后先运行一段 bootloader程序。这段 bootloader程序会先初始化 DDR等外设，然后将 Linux内核从 flash (NAND NOR FLASH SD EMMC 等 )拷贝到 DDR 中，最后启动 Linux 内核。当然了，bootloader 的实际工作要复杂的多，但是它最主要的工作就是启动 Linux 内核， bootloader 和 Linux 内核的关系就跟 PC 上的 BIOS 和 Windows 的关系一样， bootloader 就相当于 BIOS。所以我们要先搞定 bootloader，很庆幸，有很多现成的 bootloader 软件可以使用，比如 U-Boot、 vivi、 RedBoot 等等。

## 1.2 存储器

### 1.2.1 存储器的分类

#### 1. norflash-是非易失性存储器，断电后数据不会丢失

NOR flash带有SRAM接口，有足够的地址引脚进行寻址，可以很容易地*读取*其内部的每一个字节，上电后可以读取norflash中的数据但是不可以进行写操作。

#### 2. nandflash-是一种非易失性存储器，断电后数据不会丢失

NAND flash是非易失闪存（断电不丢失）的一种，但是它虽然有数据总线，但是没有地址总线，所以CPU不能直接从nandflash中取指运行，由于价格便宜，所以常常用来存储大量数据，类似于硬盘。

#### 3. SRAM-静态随机访问存储器-Static Random Access Memory

static 是指只要不掉电，存储在SRAM中的数据就不会丢失。这一点与DRAM不同，DRAM需要进行周期性刷新操作。然而，我们不应将SRAM和只读存储器（ROM）、Flash Memory相混淆，因为SRAM是一种易失性存储器，它只有在电源保持连续供应的情况下才能够保持数据。Random Access 指的是存储器的内容可以任意顺序进行访问，而不管前一次访问的是哪一个位置。上电后就可以读写SRAM中的数据，而无需初始化操作。

#### 4. SDRAM-同步动态随机访问存储器-Synchronous Dynamic Random Access Memory

需要不断的刷新，才能保存数据。而且是行列地址复用，许多都有页模式。需要对DDR控制器进行初始化<配置寄存器>，才能去读写SDRAM中的数据。

### 1.2.2 存储器在ARM处理器的作用

#### 1. NOR Flash-程序存储器

作为ARM处理器的程序存储器。因为我们必须将程序保存在一个掉电后还能保存数据的地方。上电后，NOR Flash就相当于一个随机读取的只读存储器。

一般情况下，我们编译的程序中，.text段，.rodata段都是只读的，这没有问题。但是，.data段（数据段）和 .bss（未初始化的全局变量和静态变量）在程序的运行过程中变量的值是需要改变的（改变一个变量的值，需要改变对应物理地址上存储的内容），很可惜，NOR Flash只能直接读取，而无法进行写操作。

那么，为了解决这个问题，就需要SRAM了。

#### 2. SRAM-提供运行环境

其重要特性就是：容量小，512KB；运行程序速度快；价格贵。

但是其掉电易失数据，上电后必须初始化DDR控制器，否则无法进行数据的读写。所以在运行系统内核之前必须对其进行初始化，这就是在NOR Flash 和 SRAM上搭建的程序的作用。

1. 完成对处理器时钟的初始化
2. DDR的初始化
3. 给 gd_t *gd_ptr 赋值(用于存储uboot镜像的长度，重定位地址，重定位偏移量等信息)

在uboot搬运到DDR中运行前进行最小系统的初始化，之后就将uboot搬运到DDR中运行。那么，此时NOR Flash和SRAM的任务就完成了（也就是没有用了）。

### 总结

从norflash启动可以省事多了，不仅如此，我们自己编写的裸机程序需要调试，一般也是直接烧写到norflash中进行的，因为只要我们将编译好的可执行文件放到norflash的开始，开发板上电以后就会从norflash的第一条指令开始取指执行，我们后面写裸机程序的调试就是用这种方式进行的。

从norflash启动虽然从开发的角度会很方便（其实也方便不了多少），但是从产品的角度却增加了它的成本，毕竟norflash还是相对较贵的，我们明明只要一块nandflash就足够启动整个开发板了，就没必要在产品中添加一块norflash了，只要代码改改就能省下不少成本，何乐不为。而且nandflash对产品是必不可少的，因为后面还要存放内核和文件系统，起码需要几十兆的空间，用norflash来存储也不现实。

也许你会想，能不能只用norflash，不用nandflash和SDRAM行不行呢，毕竟norflash即可以存储，也可以运行程序的啊，从理论来说是可以的，但是了解一下他们的市场价格、运行速度和工作原理，应该就会知道答案了。

# 2 UBOOT启动过程

uboot打印信息如下：

1. uboot版本号，比如图 3.2.2.1中当前 uboot版本号是 2017.09，编译时间为 2023年 5月11号 11:59:33。
2. 板子信息，当前板子是瑞芯微的 RK3568 Evaluation开发板，这个信息是可以改的，因为正点原子 ATK-DLRK3568开发板是直接参考瑞芯微官方的 RK3568开发板移植的 uboot，所以这部分信息也就没改。
3. DDR大小为 4GB（请参考根据个人开发板的配置，有可能为 2G/4G等）
4. EMMC启动设备信息。
5. PMIC芯片 (RK809)信息。
6. DRM信息，也就是屏幕信息。
7. RK3568芯片时钟信息。

rk3568 Uboot启动流程如下：

1. 上电复位：当rk3568芯片上电后，系统会进行复位操作，此时uboot程序会开始执行。
2. 加载uboot程序：在上电复位后，系统会加载uboot程序到内存中，通常uboot程序存储在flash中，可以通过Flash接口进行加载。
3. 初始化硬件：在uboot程序加载完成后，系统会进行硬件初始化，包括DDR内存、外设控制器等，以便后续操作可以正常进行。
4. 加载操作系统内核：在硬件初始化完成后，uboot程序会根据设定的启动参数加载操作系统内核到内存中，通常是加载linux系统内核。
5. 启动操作系统：一旦操作系统内核加载完成，uboot程序会将控制权交给操作系统内核，然后操作系统内核开始执行并完成系统启动。

总的来说，rk3568 Uboot启动流程包括上电复位、加载uboot程序、初始化硬件、加载操作系统内核启动操作系统等步骤。通过这些步骤，uboot程序可以顺利启动将控制权交给操作系统内核，实现系统的正常启动。

